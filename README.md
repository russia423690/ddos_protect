# Многоуровневая система защиты от DDoS-атак на FastAPI

## Описание
Это высокопроизводительное приложение на FastAPI с интеллектуальной многоуровневой системой защиты от DDoS-атак. Система предоставляет комплексную защиту веб-приложений от различных типов атак с использованием передовых методов обнаружения и блокировки вредоносного трафика.

## Основные возможности системы защиты

### 1. Многоуровневая архитектура защиты
- **Уровень 1:** Проверка IP-адресов через белый/черный список и верификация браузера
- **Уровень 2:** Интеллектуальное ограничение скорости запросов (Rate Limiting) 
- **Уровень 3:** Обнаружение аномалий в запросах и статистический анализ
- **Уровень 4:** Блокировка подозрительных IP-адресов на уровне системы (iptables)
- **Уровень 5:** Визуализация угроз и мониторинг безопасности в реальном времени

### 2. Ключевые механизмы защиты
- **Адаптивный Rate Limiting:** 120 запросов/мин для анонимных и 300 запросов/мин для авторизованных пользователей
- **Обнаружение подозрительной активности:** Анализ паттернов запросов, заголовков и поведенческих шаблонов
- **Система токенов безопасности:** Верификация легитимности клиентов через защищенные куки
- **Проверка браузера:** Защита от ботов с обязательным прохождением JavaScript-проверки
- **Отказоустойчивость:** Автоматическое переключение на локальное хранилище при недоступности Redis
- **Интеллектуальная система оценки угроз:** Блокировка после 3-х критических аномалий или 15 превышений лимита

## Технические особенности

### Технологический стек
- **Backend:** FastAPI, Python 3.10+, SQLAlchemy, Pydantic
- **База данных:** PostgreSQL с автоматическим переходом на SQLite при недоступности
- **Кэширование:** Redis (опционально) для распределенного режима работы
- **Аутентификация:** JWT-токены и API-ключи с настраиваемым сроком действия
- **Frontend:** Интерактивный HTML-интерфейс с визуализацией угроз в реальном времени
- **Системная интеграция:** Блокировка IP через iptables на уровне системы

### API и интерфейсы
- **HTML-интерфейс:** `/` - Визуализация статистики и демонстрация работы защиты
- **API-эндпоинты:**
  - `/api/stats` - Статистика работы системы в реальном времени
  - `/api/test-ddos` - Демонстрационный эндпоинт для тестирования защиты
  - `/health` - Проверка работоспособности системы и всех компонентов
  - `/api/token` - Получение JWT-токена для авторизации
  - `/api/users/me` - Информация о текущем пользователе
  - `/api/users/api-keys` - Управление API-ключами пользователя

### Безопасность и отказоустойчивость
- **Защищенные куки:** Secure, HttpOnly, SameSite=Strict для защиты от XSS и CSRF
- **Заголовки безопасности:** X-Content-Type-Options, X-Frame-Options, CSP и другие
- **Локальное хранилище:** SQLite-база для резервного хранения данных безопасности
- **Request ID:** Уникальные идентификаторы запросов для отслеживания и аудита
- **Логирование:** Подробное логирование всех событий безопасности с уровнями критичности

## Структура проекта
- `app.py` - Основное приложение FastAPI с настройкой middleware и роутеров
- `config.py` - Централизованная конфигурация всех параметров системы
- `database.py` - Настройка подключения к базам данных (PostgreSQL/SQLite)
- `models.py` - SQLAlchemy модели для хранения данных пользователей и событий безопасности
- `schemas.py` - Pydantic-схемы для валидации запросов и ответов API
- `security.py` - Основные функции безопасности и обработки событий
- `auth.py` - Аутентификация и авторизация пользователей

### Middleware (промежуточное ПО)
- `middleware/ddos_protection.py` - Основной модуль защиты от DDoS-атак
- `middleware/rate_limiter.py` - Ограничение скорости запросов и блокировка при превышении
- `middleware/anomaly_detection.py` - Обнаружение аномалий в трафике
- `middleware/cookie_check.py` - Проверка токенов безопасности в куках

### Утилиты и вспомогательные модули
- `utils/local_storage.py` - Локальное хранилище при недоступности Redis
- `utils/redis_client.py` - Клиент Redis для распределенного режима работы
- `utils/security_utils.py` - Генерация и проверка токенов безопасности
- `scripts/block_ip.sh` - Скрипт блокировки IP на уровне системы (iptables)

### Шаблоны и интерфейс
- `templates/index.html` - Главная страница с визуализацией статистики
- `templates/browser_check.html` - Страница проверки браузера
- `templates/error.html` - Шаблон страниц с информацией об ошибках

## Запуск приложения
```bash
# Запуск с помощью скрипта
./start_fastapi.sh

# Или напрямую через uvicorn
python -m uvicorn app:app --host 0.0.0.0 --port 5000
```

## Особенности работы и настройки
- **Белый список IP:** Настраивается в config.py для защиты легитимных IP-адресов от блокировки
- **Длительность блокировки:** По умолчанию 1800 секунд (30 минут), настраивается в config.py
- **Проверка браузера:** Все посетители должны пройти JavaScript проверку перед доступом к сайту
- **HTML-ответы:** Система выдает информативные HTML-страницы вместо JSON при блокировке IP
- **Локальный режим:** Автоматически включается при отсутствии подключения к Redis
- **Request ID:** Каждый запрос получает уникальный ID для отслеживания во всех логах

## Режимы работы
- **Режим демонстрации:** Включает визуализацию попыток атаки и защиты
- **Производственный режим:** Оптимизирован для максимальной защиты и производительности
- **Тестовый режим:** Включает дополнительное логирование для отладки и тестирования

## Примечания
- В производственной среде рекомендуется настройка Redis для распределенной работы
- Оптимальные настройки Rate Limiting зависят от нагрузки и характера приложения
- Для полной защиты рекомендуется использовать вместе с WAF и обратным прокси (NGINX/CloudFlare)